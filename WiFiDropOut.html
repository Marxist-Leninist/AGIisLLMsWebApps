<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Enhanced GPS Accuracy WiFi Monitor with Labeled Satellite Map</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    #status { font-size: 1.2em; padding: 10px; background-color: #f4f4f4; }
    #log { padding: 10px; height: 150px; overflow-y: scroll; border-top: 1px solid #ccc; }
    .online { color: green; }
    .offline { color: red; }
    .error { color: orange; }
    #map { height: calc(100vh - 250px); }
    h1 { margin: 10px; }
  </style>
  <!-- Include Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
  <h1>Enhanced GPS Accuracy WiFi Monitor with Labeled Satellite Map</h1>
  <div id="status">Checking connection...</div>
  <div id="map"></div>
  <div id="log"></div>

  <!-- Include Leaflet JavaScript -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- Include Kalman Filter library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/kalmanjs/1.0.0/kalman.min.js"></script>
  <script>
    var initialPosition = null;
    var map, marker, circle;
    var isFirstLoad = true;
    var kalmanFilterLat = new KalmanFilter({ R: 0.01, Q: 3 });
    var kalmanFilterLng = new KalmanFilter({ R: 0.01, Q: 3 });

    function getLocation(callback) {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          callback(position.coords);
        }, function(error) {
          console.error('Error obtaining location:', error);
          callback(null);
        }, {
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 5000
        });
      } else {
        console.error('Geolocation is not supported by this browser.');
        callback(null);
      }
    }

    function calculateDistance(coord1, coord2) {
      if (!coord1 || !coord2) return null;

      var R = 6371e3; // metres
      var φ1 = coord1.latitude * Math.PI/180;
      var φ2 = coord2.latitude * Math.PI/180;
      var Δφ = (coord2.latitude - coord1.latitude) * Math.PI/180;
      var Δλ = (coord2.longitude - coord1.longitude) * Math.PI/180;

      var a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
              Math.cos(φ1) * Math.cos(φ2) *
              Math.sin(Δλ/2) * Math.sin(Δλ/2);
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

      var d = R * c;

      return d; // in metres
    }

    function checkConnectionType() {
      if ('connection' in navigator) {
        var type = navigator.connection.effectiveType;
        if (type === 'wifi' || type === 'ethernet') {
          console.log('Connected via WiFi/Ethernet.');
          return true;
        } else if (type === 'cellular') {
          console.warn('Connected via Cellular Data.');
          return false;
        } else {
          console.warn('Connection type is unknown or not WiFi.');
          return false;
        }
      } else {
        console.warn('Network Information API not supported.');
        // Assume WiFi if API not available
        return true;
      }
    }

    function updateStatus(event) {
      var statusElement = document.getElementById('status');
      var logElement = document.getElementById('log');
      var dateTime = new Date().toLocaleString();
      var status = navigator.onLine ? 'Connected' : 'Disconnected';
      var className = navigator.onLine ? 'online' : 'offline';

      if (!checkConnectionType()) {
        status = 'Connected via Cellular Data';
        className = 'error';
      }

      getLocation(function(currentCoords) {
        if (currentCoords) {
          // Apply Kalman Filter to latitude and longitude
          currentCoords.latitude = kalmanFilterLat.filter(currentCoords.latitude);
          currentCoords.longitude = kalmanFilterLng.filter(currentCoords.longitude);
        }

        if (initialPosition === null && currentCoords) {
          initialPosition = currentCoords;
          initMap(currentCoords);
        }

        var distance = null;
        if (currentCoords && initialPosition) {
          distance = calculateDistance(initialPosition, currentCoords);
        }

        var distanceText = distance !== null ? 'Distance from start: ' + distance.toFixed(2) + ' meters' : 'Distance data not available';

        statusElement.textContent = status + ' - ' + distanceText;
        statusElement.className = className;
        logElement.innerHTML += '<div class="' + className + '">[' + dateTime + '] ' + status + ' - ' + distanceText + '</div>';
        logElement.scrollTop = logElement.scrollHeight;

        if (currentCoords) {
          updateMap(currentCoords);
        }
      });
    }

    function initMap(coords) {
      if (isFirstLoad) {
        map = L.map('map').setView([coords.latitude, coords.longitude], 18);

        // Esri World Imagery with Labels
        L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
          maxZoom: 19,
          attribution: '&copy; Esri &mdash; Esri, DeLorme, NAVTEQ',
        }).addTo(map);

        // Overlay for labels
        L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
          maxZoom: 19,
          attribution: '&copy; Esri &mdash; Esri, DeLorme, NAVTEQ',
        }).addTo(map);

        marker = L.marker([coords.latitude, coords.longitude]).addTo(map);
        circle = L.circle([coords.latitude, coords.longitude], {
          color: 'red',
          fillColor: '#f03',
          fillOpacity: 0.2,
          radius: 5
        }).addTo(map);

        isFirstLoad = false;
      }
    }

    function updateMap(coords) {
      if (marker && circle) {
        var newLatLng = L.latLng(coords.latitude, coords.longitude);
        marker.setLatLng(newLatLng);
        circle.setLatLng(newLatLng);
        map.setView(newLatLng);
      }
    }

    function startMonitoring() {
      updateStatus();
      setInterval(updateStatus, 2000); // Update every 2 seconds
    }

    window.addEventListener('load', function() {
      startMonitoring();
    });
    window.addEventListener('online', updateStatus);
    window.addEventListener('offline', updateStatus);
  </script>
</body>
</html>
