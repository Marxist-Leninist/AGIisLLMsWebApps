<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hearts of Steel - WW2 Grand Strategy</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  background: #1a1a2e;
  color: #eee;
  font-family: 'Segoe UI', system-ui, sans-serif;
  overflow: hidden;
  height: 100vh;
  font-size: 12px;
}
.game-container { display: flex; height: 100vh; }
.sidebar {
  width: 280px;
  background: linear-gradient(180deg, #16213e 0%, #1a1a2e 100%);
  border-right: 2px solid #2a3f5f;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  z-index: 1000;
}
.sidebar-header {
  padding: 10px;
  background: #0f3460;
  border-bottom: 2px solid #2a3f5f;
}
.sidebar-header h2 { font-size: 13px; color: #e94560; margin-bottom: 6px; }
.date-display { font-size: 16px; font-weight: bold; color: #fff; }
.speed-controls { display: flex; gap: 4px; margin-top: 6px; }
.speed-controls button {
  padding: 3px 8px;
  background: #2a3f5f;
  border: 1px solid #3a5f8f;
  color: #fff;
  cursor: pointer;
  border-radius: 3px;
  font-size: 11px;
}
.speed-controls button:hover { background: #3a5f8f; }
.speed-controls button.active { background: #e94560; border-color: #e94560; }

.resources {
  padding: 8px;
  background: rgba(0,0,0,0.3);
  border-bottom: 1px solid #2a3f5f;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 4px;
  font-size: 11px;
}
.resource { display: flex; align-items: center; gap: 4px; }
.resource-change { font-size: 9px; }
.resource-change.positive { color: #22c55e; }
.resource-change.negative { color: #e94560; }

.country-info { padding: 8px; border-bottom: 1px solid #2a3f5f; }
.country-name { font-size: 14px; font-weight: bold; }

.tabs {
  display: flex;
  border-bottom: 1px solid #2a3f5f;
}
.tab {
  flex: 1;
  padding: 8px 4px;
  background: #16213e;
  border: none;
  color: #888;
  cursor: pointer;
  font-size: 10px;
  text-align: center;
}
.tab:hover { color: #fff; }
.tab.active { background: #0f3460; color: #e94560; border-bottom: 2px solid #e94560; }

.tab-content { flex: 1; overflow-y: auto; display: none; }
.tab-content.active { display: block; }

.section-title {
  padding: 6px 8px;
  background: #0f3460;
  font-size: 11px;
  font-weight: bold;
  color: #e94560;
}

.army-list { padding: 6px; }
.army-item {
  background: rgba(0,0,0,0.3);
  border: 1px solid #2a3f5f;
  border-radius: 4px;
  padding: 6px;
  margin-bottom: 4px;
  cursor: pointer;
  font-size: 11px;
}
.army-item:hover { background: rgba(233,69,96,0.2); border-color: #e94560; }
.army-item.selected { background: rgba(233,69,96,0.3); border-color: #e94560; }
.army-name { font-weight: bold; }
.army-details { font-size: 10px; color: #aaa; margin-top: 2px; }
.strength-bar { height: 3px; background: #333; border-radius: 2px; margin-top: 3px; }
.strength-fill { height: 100%; border-radius: 2px; }

/* Production Tab */
.production-section { padding: 8px; }
.production-queue {
  background: rgba(0,0,0,0.2);
  border-radius: 4px;
  padding: 6px;
  margin-bottom: 8px;
}
.queue-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 4px;
  background: rgba(0,0,0,0.3);
  border-radius: 3px;
  margin-bottom: 3px;
}
.queue-progress {
  width: 60px;
  height: 6px;
  background: #333;
  border-radius: 3px;
  overflow: hidden;
}
.queue-progress-fill {
  height: 100%;
  background: #22c55e;
  transition: width 0.3s;
}
.queue-cancel {
  background: #e94560;
  border: none;
  color: #fff;
  width: 16px;
  height: 16px;
  border-radius: 2px;
  cursor: pointer;
  font-size: 10px;
}

.production-options { margin-top: 8px; }
.prod-option {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 6px;
  background: rgba(0,0,0,0.2);
  border: 1px solid #2a3f5f;
  border-radius: 4px;
  margin-bottom: 4px;
}
.prod-option:hover { border-color: #3a5f8f; }
.prod-info { flex: 1; }
.prod-name { font-weight: bold; font-size: 11px; }
.prod-cost { font-size: 9px; color: #aaa; }
.prod-btn {
  padding: 4px 8px;
  background: #22c55e;
  border: none;
  color: #fff;
  border-radius: 3px;
  cursor: pointer;
  font-size: 10px;
}
.prod-btn:hover { background: #16a34a; }
.prod-btn:disabled { background: #444; cursor: not-allowed; }

/* Factory allocation */
.factory-allocation {
  background: rgba(0,0,0,0.2);
  border-radius: 4px;
  padding: 8px;
  margin-bottom: 8px;
}
.factory-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 4px;
}
.factory-slider {
  width: 100px;
  height: 6px;
  -webkit-appearance: none;
  background: #333;
  border-radius: 3px;
  outline: none;
}
.factory-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 12px;
  height: 12px;
  background: #e94560;
  border-radius: 50%;
  cursor: pointer;
}

/* Economy Tab */
.economy-section { padding: 8px; }
.econ-stat {
  display: flex;
  justify-content: space-between;
  padding: 4px 0;
  border-bottom: 1px solid #2a3f5f;
}
.econ-bar {
  width: 100%;
  height: 8px;
  background: #333;
  border-radius: 4px;
  margin-top: 4px;
  overflow: hidden;
}
.econ-bar-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.3s;
}

.main-area { flex: 1; display: flex; flex-direction: column; }
.top-bar {
  height: 32px;
  background: #0f3460;
  border-bottom: 2px solid #2a3f5f;
  display: flex;
  align-items: center;
  padding: 0 10px;
  gap: 8px;
  font-size: 11px;
  z-index: 1000;
}
.top-bar span { margin-left: auto; }

#map { flex: 1; background: #0a1628; }

.bottom-bar {
  height: 50px;
  background: #0f3460;
  border-top: 2px solid #2a3f5f;
  padding: 6px 12px;
  display: flex;
  align-items: center;
  gap: 10px;
  z-index: 1000;
}
.selected-info { flex: 1; }
.selected-info h3 { font-size: 12px; color: #e94560; }
.selected-info p { font-size: 10px; color: #aaa; }
.action-buttons { display: flex; gap: 6px; }
.action-buttons button {
  padding: 6px 12px;
  background: #e94560;
  border: none;
  color: #fff;
  cursor: pointer;
  border-radius: 4px;
  font-weight: bold;
  font-size: 11px;
}
.action-buttons button:hover { background: #ff6b8a; }
.action-buttons button.secondary { background: #2a3f5f; }

.notification {
  position: fixed;
  top: 40px;
  right: 10px;
  background: rgba(15,52,96,0.95);
  border: 2px solid #e94560;
  padding: 8px 12px;
  border-radius: 4px;
  z-index: 2000;
  font-size: 11px;
  animation: slideIn 0.3s ease;
  max-width: 250px;
}
@keyframes slideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 3000;
}
.modal-content {
  background: #16213e;
  border: 2px solid #e94560;
  border-radius: 8px;
  padding: 20px;
  max-width: 400px;
  text-align: center;
}
.modal h2 { color: #e94560; margin-bottom: 12px; font-size: 18px; }
.modal p { margin-bottom: 15px; color: #aaa; font-size: 12px; }
.modal button {
  padding: 8px 20px;
  background: #e94560;
  border: none;
  color: #fff;
  cursor: pointer;
  border-radius: 4px;
  font-weight: bold;
  margin: 4px;
  font-size: 12px;
}
.hidden { display: none !important; }

.army-marker {
  background: rgba(0,0,0,0.85);
  border: 2px solid;
  border-radius: 4px;
  padding: 2px 5px;
  font-size: 10px;
  font-weight: bold;
  color: #fff;
  white-space: nowrap;
  text-align: center;
}
.battle-marker {
  font-size: 24px;
  animation: pulse 0.5s infinite alternate;
  filter: drop-shadow(0 0 4px #e94560);
}
@keyframes pulse {
  from { transform: scale(1); }
  to { transform: scale(1.3); }
}
.leaflet-container { background: #0a1628 !important; }
.loading {
  position: fixed;
  inset: 0;
  background: #1a1a2e;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 5000;
  font-size: 16px;
}

/* Deploy modal */
.deploy-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 6px;
  max-height: 300px;
  overflow-y: auto;
  margin: 10px 0;
  text-align: left;
}
.deploy-option {
  padding: 8px;
  background: rgba(0,0,0,0.3);
  border: 1px solid #2a3f5f;
  border-radius: 4px;
  cursor: pointer;
  font-size: 11px;
}
.deploy-option:hover { border-color: #e94560; background: rgba(233,69,96,0.2); }
</style>
</head>
<body>
<div class="loading" id="loading">Loading map data...</div>

<div class="game-container">
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>‚öîÔ∏è HEARTS OF STEEL</h2>
      <div class="date-display" id="dateDisplay">1 September 1939</div>
      <div class="speed-controls">
        <button id="pauseBtn" class="active">‚è∏</button>
        <button id="speed1Btn">‚ñ∂</button>
        <button id="speed2Btn">‚ñ∂‚ñ∂</button>
        <button id="speed3Btn">‚ñ∂‚ñ∂‚ñ∂</button>
      </div>
    </div>
    
    <div class="resources" id="resources"></div>
    <div class="country-info" id="countryInfo"></div>
    
    <div class="tabs">
      <button class="tab active" onclick="switchTab('armies')">üö∂ Armies</button>
      <button class="tab" onclick="switchTab('production')">üè≠ Production</button>
      <button class="tab" onclick="switchTab('economy')">üìä Economy</button>
    </div>
    
    <div class="tab-content active" id="armiesTab">
      <div class="section-title">YOUR ARMIES</div>
      <div class="army-list" id="armyList"></div>
    </div>
    
    <div class="tab-content" id="productionTab">
      <div class="section-title">FACTORY ALLOCATION</div>
      <div class="production-section">
        <div class="factory-allocation" id="factoryAllocation"></div>
        
        <div class="section-title">PRODUCTION QUEUE</div>
        <div class="production-queue" id="productionQueue">
          <div style="color:#666;text-align:center;padding:10px;">No units in production</div>
        </div>
        
        <div class="section-title">BUILD NEW UNITS</div>
        <div class="production-options" id="productionOptions"></div>
      </div>
    </div>
    
    <div class="tab-content" id="economyTab">
      <div class="section-title">NATIONAL ECONOMY</div>
      <div class="economy-section" id="economySection"></div>
    </div>
  </div>
  
  <div class="main-area">
    <div class="top-bar">
      <span id="warStatus" style="color:#e94560;font-weight:bold;"></span>
    </div>
    
    <div id="map"></div>
    
    <div class="bottom-bar">
      <div class="selected-info" id="selectedInfo">
        <h3>Select a territory or army</h3>
        <p>Click to interact</p>
      </div>
      <div class="action-buttons" id="actionButtons"></div>
    </div>
  </div>
</div>

<div class="modal hidden" id="countrySelect">
  <div class="modal-content">
    <h2>SELECT YOUR NATION</h2>
    <p>Lead a major power in World War II</p>
    <button onclick="selectCountry('DEU')">üá©üá™ Germany</button>
    <button onclick="selectCountry('GBR')">üá¨üáß United Kingdom</button>
    <button onclick="selectCountry('FRA')">üá´üá∑ France</button>
    <button onclick="selectCountry('RUS')">üá∑üá∫ Soviet Union</button>
  </div>
</div>

<div class="modal hidden" id="deployModal">
  <div class="modal-content">
    <h2>DEPLOY DIVISION</h2>
    <p>Select deployment location:</p>
    <div class="deploy-grid" id="deployGrid"></div>
    <button onclick="closeDeployModal()">Cancel</button>
  </div>
</div>

<div class="modal hidden" id="victoryModal">
  <div class="modal-content">
    <h2 id="victoryText">VICTORY!</h2>
    <p id="victoryDesc"></p>
    <button onclick="location.reload()">Play Again</button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

// Map
const map = L.map('map', {
  center: [52, 20],
  zoom: 4,
  minZoom: 3,
  maxZoom: 7
});

L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
  attribution: '¬©OSM ¬©CartoDB',
  subdomains: 'abcd'
}).addTo(map);

// Game state
const state = {
  player: null,
  date: new Date(1939, 8, 1),
  speed: 0,
  selectedArmy: null,
  selectedProvince: null,
  economy: {
    manpower: 500000,
    equipment: 10000,
    factories: { military: 10, civilian: 5 },
    resources: { steel: 50, oil: 30 },
    dailyManpower: 1000,
    dailyEquipment: 0
  },
  productionQueue: []
};

// Unit templates
const unitTemplates = {
  infantry: { name: 'Infantry Division', manpower: 10000, equipment: 500, time: 30, icon: 'üö∂' },
  armor: { name: 'Panzer Division', manpower: 5000, equipment: 2000, time: 60, icon: 'üõ°Ô∏è' },
  motorized: { name: 'Motorized Division', manpower: 8000, equipment: 1000, time: 45, icon: 'üöó' },
  artillery: { name: 'Artillery Brigade', manpower: 3000, equipment: 800, time: 25, icon: 'üí•' }
};

// Countries
const countries = {
  DEU: { name: 'Germany', color: '#5a5a5a', flag: 'üá©üá™', manpower: 8000000, factories: { military: 15, civilian: 10 }, resources: { steel: 80, oil: 20 } },
  GBR: { name: 'United Kingdom', color: '#c45c8c', flag: 'üá¨üáß', manpower: 4000000, factories: { military: 10, civilian: 8 }, resources: { steel: 60, oil: 40 } },
  FRA: { name: 'France', color: '#5c7cc4', flag: 'üá´üá∑', manpower: 3000000, factories: { military: 8, civilian: 6 }, resources: { steel: 40, oil: 20 } },
  RUS: { name: 'Soviet Union', color: '#c44040', flag: 'üá∑üá∫', manpower: 12000000, factories: { military: 12, civilian: 8 }, resources: { steel: 100, oil: 80 } },
  POL: { name: 'Poland', color: '#c4a05c', flag: 'üáµüá±', ai: true },
  ITA: { name: 'Italy', color: '#4c8c4c', flag: 'üáÆüáπ', ai: true },
  NLD: { name: 'Netherlands', color: '#f4a460', flag: 'üá≥üá±', ai: true },
  BEL: { name: 'Belgium', color: '#daa520', flag: 'üáßüá™', ai: true },
  DNK: { name: 'Denmark', color: '#cd5c5c', flag: 'üá©üá∞', ai: true },
  NOR: { name: 'Norway', color: '#4682b4', flag: 'üá≥üá¥', ai: true },
  SWE: { name: 'Sweden', color: '#4169e1', flag: 'üá∏üá™', ai: true },
  FIN: { name: 'Finland', color: '#b0c4de', flag: 'üá´üáÆ', ai: true },
  AUT: { name: 'Austria', color: '#5a5a5a', flag: 'üá¶üáπ', ai: true },
  CZE: { name: 'Czechoslovakia', color: '#5a5a5a', flag: 'üá®üáø', ai: true },
  HUN: { name: 'Hungary', color: '#8b4513', flag: 'üá≠üá∫', ai: true },
  ROU: { name: 'Romania', color: '#ffd700', flag: 'üá∑üá¥', ai: true },
  BGR: { name: 'Bulgaria', color: '#228b22', flag: 'üáßüá¨', ai: true },
  YUG: { name: 'Yugoslavia', color: '#708090', flag: 'üá∑üá∏', ai: true },
  GRC: { name: 'Greece', color: '#00bfff', flag: 'üá¨üá∑', ai: true },
  ESP: { name: 'Spain', color: '#8b0000', flag: 'üá™üá∏', ai: true },
  PRT: { name: 'Portugal', color: '#006400', flag: 'üáµüáπ', ai: true },
  CHE: { name: 'Switzerland', color: '#ffffff', flag: 'üá®üá≠', ai: true },
  IRL: { name: 'Ireland', color: '#228b22', flag: 'üáÆüá™', ai: true },
  UKR: { name: 'Ukraine', color: '#c44040', flag: 'üá∫üá¶', ai: true },
  BLR: { name: 'Belarus', color: '#c44040', flag: 'üáßüáæ', ai: true },
  LTU: { name: 'Lithuania', color: '#c44040', flag: 'üá±üáπ', ai: true },
  LVA: { name: 'Latvia', color: '#c44040', flag: 'üá±üáª', ai: true },
  EST: { name: 'Estonia', color: '#c44040', flag: 'üá™üá™', ai: true },
};

const ownership1939 = {
  DEU: 'DEU', GBR: 'GBR', FRA: 'FRA', RUS: 'RUS', POL: 'POL', ITA: 'ITA',
  NLD: 'NLD', BEL: 'BEL', DNK: 'DNK', NOR: 'NOR', SWE: 'SWE', FIN: 'FIN',
  AUT: 'DEU', CZE: 'DEU', HUN: 'HUN', ROU: 'ROU', BGR: 'BGR', YUG: 'YUG', GRC: 'GRC',
  ESP: 'ESP', PRT: 'PRT', CHE: 'CHE', IRL: 'IRL',
  UKR: 'RUS', BLR: 'RUS', LTU: 'RUS', LVA: 'RUS', EST: 'RUS'
};

const vpValues = {
  DEU: 10, GBR: 10, FRA: 10, RUS: 15, POL: 8, ITA: 6,
  NLD: 2, BEL: 2, DNK: 1, NOR: 2, SWE: 3, FIN: 2,
  AUT: 3, CZE: 4, HUN: 3, ROU: 4, BGR: 2, YUG: 3, GRC: 2,
  ESP: 4, PRT: 2, CHE: 1, IRL: 1, UKR: 6, BLR: 3, LTU: 1, LVA: 1, EST: 1
};

const industryValues = {
  DEU: 30, GBR: 30, FRA: 25, RUS: 40, POL: 15, ITA: 20,
  NLD: 8, BEL: 10, DNK: 4, NOR: 5, SWE: 10, FIN: 6,
  AUT: 10, CZE: 15, HUN: 8, ROU: 10, BGR: 5, YUG: 6, GRC: 5,
  ESP: 12, PRT: 4, CHE: 5, IRL: 3, UKR: 18, BLR: 10, LTU: 3, LVA: 3, EST: 3
};

const countryCenters = {
  DEU: [52.5, 13.4], GBR: [52.0, -1.0], FRA: [48.8, 2.3], RUS: [55.7, 37.6],
  POL: [52.2, 21.0], ITA: [42.0, 12.5], NLD: [52.3, 4.9], BEL: [50.8, 4.4],
  DNK: [55.7, 12.6], NOR: [62.0, 10.0], SWE: [62.0, 16.0], FIN: [62.0, 26.0],
  AUT: [48.2, 16.4], CZE: [50.0, 14.4], HUN: [47.5, 19.0], ROU: [44.4, 26.1],
  BGR: [42.7, 23.3], YUG: [44.8, 20.5], GRC: [38.0, 23.7], ESP: [40.4, -3.7],
  PRT: [38.7, -9.1], CHE: [46.9, 8.2], IRL: [53.3, -6.3], UKR: [50.4, 30.5],
  BLR: [53.9, 27.6], LTU: [54.7, 25.3], LVA: [56.9, 24.1], EST: [59.4, 24.7]
};

const adjacency = {
  DEU: ['POL', 'CZE', 'AUT', 'CHE', 'FRA', 'BEL', 'NLD', 'DNK'],
  GBR: ['IRL', 'FRA', 'BEL', 'NLD', 'NOR'],
  FRA: ['ESP', 'ITA', 'CHE', 'DEU', 'BEL', 'GBR'],
  RUS: ['FIN', 'EST', 'LVA', 'LTU', 'POL', 'UKR', 'BLR', 'ROU'],
  POL: ['DEU', 'CZE', 'RUS', 'LTU', 'BLR', 'UKR', 'ROU'],
  ITA: ['FRA', 'CHE', 'AUT', 'YUG', 'GRC'],
  NLD: ['DEU', 'BEL', 'GBR'],
  BEL: ['FRA', 'DEU', 'NLD', 'GBR'],
  DNK: ['DEU', 'NOR', 'SWE'],
  NOR: ['SWE', 'FIN', 'DNK', 'GBR'],
  SWE: ['NOR', 'FIN', 'DNK'],
  FIN: ['NOR', 'SWE', 'RUS'],
  AUT: ['DEU', 'CZE', 'HUN', 'YUG', 'ITA', 'CHE'],
  CZE: ['DEU', 'POL', 'AUT', 'HUN'],
  HUN: ['AUT', 'CZE', 'POL', 'ROU', 'YUG'],
  ROU: ['HUN', 'YUG', 'BGR', 'UKR', 'RUS', 'POL'],
  BGR: ['ROU', 'YUG', 'GRC'],
  YUG: ['ITA', 'AUT', 'HUN', 'ROU', 'BGR', 'GRC'],
  GRC: ['YUG', 'BGR', 'ITA'],
  ESP: ['FRA', 'PRT'],
  PRT: ['ESP'],
  CHE: ['FRA', 'DEU', 'AUT', 'ITA'],
  IRL: ['GBR'],
  UKR: ['POL', 'ROU', 'BLR', 'RUS'],
  BLR: ['POL', 'LTU', 'LVA', 'RUS', 'UKR'],
  LTU: ['POL', 'BLR', 'LVA'],
  LVA: ['LTU', 'EST', 'BLR', 'RUS'],
  EST: ['LVA', 'RUS', 'FIN']
};

let provinces = [];
let provinceLayers = {};
let armies = [];
let battles = [];
let wars = [];
let armyMarkers = {};
let battleMarkers = {};
let nextArmyId = 100;

function initArmies() {
  armies = [
    { id: 1, name: '1st Panzer', country: 'DEU', province: 'DEU', divisions: 12, strength: 100, type: 'armor' },
    { id: 2, name: '2nd Army', country: 'DEU', province: 'DEU', divisions: 18, strength: 100, type: 'infantry' },
    { id: 3, name: '3rd Army', country: 'DEU', province: 'CZE', divisions: 12, strength: 100, type: 'infantry' },
    { id: 4, name: '4th Army', country: 'DEU', province: 'AUT', divisions: 10, strength: 100, type: 'infantry' },
    { id: 5, name: 'Polish 1st', country: 'POL', province: 'POL', divisions: 10, strength: 100, type: 'infantry' },
    { id: 6, name: 'Polish 2nd', country: 'POL', province: 'POL', divisions: 8, strength: 100, type: 'infantry' },
    { id: 7, name: 'French 1st', country: 'FRA', province: 'FRA', divisions: 15, strength: 100, type: 'infantry' },
    { id: 8, name: 'French 2nd', country: 'FRA', province: 'FRA', divisions: 12, strength: 100, type: 'infantry' },
    { id: 9, name: 'BEF', country: 'GBR', province: 'GBR', divisions: 10, strength: 100, type: 'infantry' },
    { id: 10, name: 'Red Army W', country: 'RUS', province: 'BLR', divisions: 30, strength: 100, type: 'infantry' },
    { id: 11, name: 'Red Army S', country: 'RUS', province: 'UKR', divisions: 25, strength: 100, type: 'infantry' },
    { id: 12, name: 'Red Reserve', country: 'RUS', province: 'RUS', divisions: 20, strength: 100, type: 'infantry' },
    { id: 13, name: 'Italian Army', country: 'ITA', province: 'ITA', divisions: 12, strength: 100, type: 'infantry' },
  ];
}

async function loadGeoJSON() {
  try {
    const response = await fetch('https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson');
    const data = await response.json();
    
    const europeanCodes = Object.keys(countries);
    data.features = data.features.filter(f => europeanCodes.includes(f.properties.ISO_A3));
    
    data.features.forEach(f => {
      const code = f.properties.ISO_A3;
      if (countries[code]) {
        provinces.push({
          id: code,
          name: countries[code].name,
          owner: ownership1939[code] || code,
          vp: vpValues[code] || 1,
          industry: industryValues[code] || 5,
          capital: ['DEU', 'GBR', 'FRA', 'RUS'].includes(code),
          center: countryCenters[code] || [50, 10]
        });
      }
    });
    
    L.geoJSON(data, {
      style: feature => {
        const code = feature.properties.ISO_A3;
        const prov = provinces.find(p => p.id === code);
        const owner = prov ? prov.owner : code;
        return {
          fillColor: countries[owner]?.color || '#555',
          weight: 2,
          opacity: 1,
          color: '#000',
          fillOpacity: 0.7
        };
      },
      onEachFeature: (feature, layer) => {
        const code = feature.properties.ISO_A3;
        const prov = provinces.find(p => p.id === code);
        if (prov) {
          provinceLayers[code] = layer;
          layer.on('click', () => clickProvince(code));
          layer.on('mouseover', function() { this.setStyle({ weight: 3, fillOpacity: 0.85 }); });
          layer.on('mouseout', function() { this.setStyle({ weight: 2, fillOpacity: 0.7 }); });
          layer.bindTooltip(() => {
            const p = provinces.find(x => x.id === code);
            const o = countries[p.owner];
            const armiesHere = armies.filter(a => a.province === code);
            return `<b>${p.name}</b><br>${o?.flag || ''} ${o?.name || p.owner}<br>VP: ${p.vp} | Industry: ${p.industry}<br>Armies: ${armiesHere.length}`;
          }, { sticky: true });
        }
      }
    }).addTo(map);
    
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('countrySelect').classList.remove('hidden');
  } catch (err) {
    console.error(err);
    document.getElementById('loading').textContent = 'Failed to load. Refresh.';
  }
}

function selectCountry(countryId) {
  state.player = countryId;
  
  // Initialize economy based on country
  const c = countries[countryId];
  state.economy = {
    manpower: Math.floor(c.manpower * 0.1),
    equipment: 15000,
    factories: { ...c.factories },
    resources: { ...c.resources },
    dailyManpower: Math.floor(c.manpower / 10000),
    dailyEquipment: 0
  };
  
  document.getElementById('countrySelect').classList.add('hidden');
  
  if (countryId === 'DEU') {
    wars.push({ attacker: 'DEU', defender: 'POL' });
    notify('War declared on Poland!');
  } else {
    wars.push({ attacker: 'DEU', defender: 'POL' });
    setTimeout(() => {
      if (['FRA', 'GBR'].includes(countryId)) {
        wars.push({ attacker: 'DEU', defender: 'FRA' });
        wars.push({ attacker: 'DEU', defender: 'GBR' });
        notify('Germany declares war!');
      }
    }, 2000);
  }
  
  render();
  requestAnimationFrame(gameLoop);
}

function isAtWar(c1, c2) {
  return wars.some(w => (w.attacker === c1 && w.defender === c2) || (w.attacker === c2 && w.defender === c1));
}

function getEnemies(country) {
  const e = new Set();
  wars.forEach(w => {
    if (w.attacker === country) e.add(w.defender);
    if (w.defender === country) e.add(w.attacker);
  });
  return [...e];
}

// Tab switching
window.switchTab = function(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelector(`.tab-content#${tab}Tab`).classList.add('active');
  document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
  render();
};

function render() {
  renderResources();
  renderCountryInfo();
  renderArmyList();
  renderProduction();
  renderEconomy();
  updateMap();
  renderWarStatus();
  renderBottomBar();
}

function renderResources() {
  const e = state.economy;
  const equipChange = e.factories.military * 50;
  document.getElementById('resources').innerHTML = `
    <div class="resource">üë• ${(e.manpower/1000).toFixed(0)}K <span class="resource-change positive">+${e.dailyManpower}</span></div>
    <div class="resource">üîß ${(e.equipment/1000).toFixed(1)}K <span class="resource-change positive">+${equipChange}/d</span></div>
    <div class="resource">üè≠ ${e.factories.military} Mil / ${e.factories.civilian} Civ</div>
    <div class="resource">üî© ${e.resources.steel} üõ¢Ô∏è ${e.resources.oil}</div>
  `;
}

function renderCountryInfo() {
  const c = countries[state.player];
  if (!c) return;
  const owned = provinces.filter(p => p.owner === state.player);
  const vp = owned.reduce((s, p) => s + p.vp, 0);
  const totalDiv = armies.filter(a => a.country === state.player).reduce((s, a) => s + a.divisions, 0);
  document.getElementById('countryInfo').innerHTML = `
    <span style="font-size:20px;margin-right:6px;">${c.flag}</span>
    <span class="country-name">${c.name}</span>
    <div style="font-size:10px;color:#aaa;margin-top:2px;">${owned.length} Territories | ${vp} VP | ${totalDiv} Divisions</div>
  `;
}

function renderArmyList() {
  const playerArmies = armies.filter(a => a.country === state.player);
  document.getElementById('armyList').innerHTML = playerArmies.length ? playerArmies.map(army => {
    const prov = provinces.find(p => p.id === army.province);
    return `
    <div class="army-item ${state.selectedArmy === army.id ? 'selected' : ''}" onclick="selectArmy(${army.id})">
      <div class="army-name">${army.type === 'armor' ? 'üõ°Ô∏è' : 'üö∂'} ${army.name}</div>
      <div class="army-details">${army.divisions} div ‚Ä¢ ${prov?.name || army.province} ‚Ä¢ ${army.strength}%</div>
      <div class="strength-bar"><div class="strength-fill" style="width:${army.strength}%;background:${army.strength > 50 ? '#22c55e' : '#e94560'}"></div></div>
    </div>
  `}).join('') : '<div style="padding:10px;color:#666;text-align:center;">No armies</div>';
}

function renderProduction() {
  const e = state.economy;
  
  // Factory allocation
  document.getElementById('factoryAllocation').innerHTML = `
    <div style="margin-bottom:6px;font-weight:bold;">Factories: ${e.factories.military + e.factories.civilian} total</div>
    <div class="factory-row">
      <span>üè≠ Military (${e.factories.military})</span>
      <span style="color:#22c55e;">+${e.factories.military * 50} equip/day</span>
    </div>
    <div class="factory-row">
      <span>üèóÔ∏è Civilian (${e.factories.civilian})</span>
      <span style="color:#5c7cc4;">+${e.factories.civilian * 10} industry</span>
    </div>
  `;
  
  // Production queue
  const queue = state.productionQueue;
  document.getElementById('productionQueue').innerHTML = queue.length ? queue.map((item, i) => `
    <div class="queue-item">
      <span>${unitTemplates[item.type].icon} ${unitTemplates[item.type].name}</span>
      <div class="queue-progress"><div class="queue-progress-fill" style="width:${(item.progress/item.time)*100}%"></div></div>
      <span>${item.progress}/${item.time}d</span>
      <button class="queue-cancel" onclick="cancelProduction(${i})">‚úï</button>
    </div>
  `).join('') : '<div style="color:#666;text-align:center;padding:8px;">Queue empty</div>';
  
  // Production options
  document.getElementById('productionOptions').innerHTML = Object.entries(unitTemplates).map(([type, unit]) => {
    const canAfford = e.manpower >= unit.manpower && e.equipment >= unit.equipment;
    return `
    <div class="prod-option">
      <div class="prod-info">
        <div class="prod-name">${unit.icon} ${unit.name}</div>
        <div class="prod-cost">üë• ${(unit.manpower/1000).toFixed(0)}K | üîß ${unit.equipment} | ‚è±Ô∏è ${unit.time}d</div>
      </div>
      <button class="prod-btn" ${canAfford ? '' : 'disabled'} onclick="startProduction('${type}')">Build</button>
    </div>
  `}).join('');
}

function renderEconomy() {
  const e = state.economy;
  const totalIndustry = provinces.filter(p => p.owner === state.player).reduce((s, p) => s + p.industry, 0);
  const totalFactories = e.factories.military + e.factories.civilian;
  
  document.getElementById('economySection').innerHTML = `
    <div class="econ-stat"><span>Total Industry</span><span>${totalIndustry}</span></div>
    <div class="econ-stat"><span>Military Factories</span><span>${e.factories.military}</span></div>
    <div class="econ-stat"><span>Civilian Factories</span><span>${e.factories.civilian}</span></div>
    <div class="econ-stat"><span>Daily Equipment</span><span>+${e.factories.military * 50}</span></div>
    <div class="econ-stat"><span>Daily Manpower</span><span>+${e.dailyManpower}</span></div>
    <div class="econ-stat"><span>Steel Reserves</span><span>${e.resources.steel}</span></div>
    <div class="econ-stat"><span>Oil Reserves</span><span>${e.resources.oil}</span></div>
    
    <div class="section-title" style="margin-top:10px;">MANPOWER POOL</div>
    <div class="econ-bar"><div class="econ-bar-fill" style="width:${Math.min(100, e.manpower/10000)}%;background:#22c55e;"></div></div>
    <div style="text-align:center;margin-top:4px;">${(e.manpower/1000).toFixed(0)}K available</div>
    
    <div class="section-title" style="margin-top:10px;">EQUIPMENT STOCKPILE</div>
    <div class="econ-bar"><div class="econ-bar-fill" style="width:${Math.min(100, e.equipment/500)}%;background:#5c7cc4;"></div></div>
    <div style="text-align:center;margin-top:4px;">${(e.equipment/1000).toFixed(1)}K stored</div>
  `;
}

function updateMap() {
  provinces.forEach(prov => {
    const layer = provinceLayers[prov.id];
    if (!layer) return;
    
    let color = countries[prov.owner]?.color || '#555';
    let weight = 2;
    
    if (state.selectedProvince === prov.id) weight = 4;
    
    if (state.selectedArmy) {
      const army = armies.find(a => a.id === state.selectedArmy);
      if (army && adjacency[army.province]?.includes(prov.id)) {
        const canMove = prov.owner === state.player || isAtWar(state.player, prov.owner) || !['DEU','GBR','FRA','RUS','POL','ITA'].includes(prov.owner);
        if (canMove) color = '#22c55e';
      }
    }
    
    layer.setStyle({ fillColor: color, weight: weight });
  });
  
  // Army markers
  Object.values(armyMarkers).forEach(m => map.removeLayer(m));
  armyMarkers = {};
  
  const armyGroups = {};
  armies.forEach(a => {
    if (!armyGroups[a.province]) armyGroups[a.province] = [];
    armyGroups[a.province].push(a);
  });
  
  Object.entries(armyGroups).forEach(([provId, provArmies]) => {
    const center = countryCenters[provId];
    if (!center) return;
    const totalDiv = provArmies.reduce((s, a) => s + a.divisions, 0);
    const mainCountry = provArmies[0].country;
    
    const icon = L.divIcon({
      className: 'army-marker',
      html: `<div style="border-color:${countries[mainCountry]?.color}">${totalDiv}</div>`,
      iconSize: [32, 20]
    });
    
    const marker = L.marker(center, { icon }).addTo(map);
    marker.bindTooltip(provArmies.map(a => `${a.name}: ${a.divisions} div`).join('<br>'));
    armyMarkers[provId] = marker;
  });
  
  // Battle markers
  Object.values(battleMarkers).forEach(m => map.removeLayer(m));
  battleMarkers = {};
  
  battles.forEach((b, i) => {
    const center = countryCenters[b.province];
    if (!center) return;
    const icon = L.divIcon({ className: 'battle-marker', html: '‚öîÔ∏è', iconSize: [28, 28] });
    battleMarkers[i] = L.marker(center, { icon }).addTo(map);
  });
}

function renderWarStatus() {
  const enemies = getEnemies(state.player);
  document.getElementById('warStatus').textContent = enemies.length 
    ? `‚öîÔ∏è AT WAR: ${enemies.map(e => countries[e]?.name).join(', ')}`
    : '‚òÆÔ∏è At Peace';
}

function renderBottomBar() {
  const info = document.getElementById('selectedInfo');
  const btns = document.getElementById('actionButtons');
  
  if (state.selectedArmy) {
    const army = armies.find(a => a.id === state.selectedArmy);
    if (army) {
      const prov = provinces.find(p => p.id === army.province);
      info.innerHTML = `<h3>${army.name}</h3><p>${army.divisions} div | ${army.strength}% | ${prov?.name || army.province}</p>`;
      btns.innerHTML = `<button onclick="deselectArmy()">Deselect</button>`;
    }
  } else if (state.selectedProvince) {
    const prov = provinces.find(p => p.id === state.selectedProvince);
    if (prov) {
      const here = armies.filter(a => a.province === prov.id);
      const mine = here.filter(a => a.country === state.player);
      info.innerHTML = `<h3>${prov.name} (${countries[prov.owner]?.name})</h3><p>VP: ${prov.vp} | Industry: ${prov.industry} | Armies: ${here.length}</p>`;
      btns.innerHTML = mine.length ? `<button onclick="selectArmy(${mine[0].id})">Select Army</button>` : '';
    }
  } else {
    info.innerHTML = `<h3>Select territory or army</h3><p>Click to interact</p>`;
    btns.innerHTML = '';
  }
}

window.selectArmy = function(id) {
  const army = armies.find(a => a.id === id);
  if (army && army.country === state.player) {
    state.selectedArmy = id;
    state.selectedProvince = null;
    render();
  }
};

window.deselectArmy = function() {
  state.selectedArmy = null;
  render();
};

function clickProvince(id) {
  if (state.selectedArmy) {
    const army = armies.find(a => a.id === state.selectedArmy);
    if (army && adjacency[army.province]?.includes(id)) {
      const target = provinces.find(p => p.id === id);
      const isMajor = ['DEU','GBR','FRA','RUS','POL','ITA'].includes(target.owner);
      const canMove = target.owner === state.player || isAtWar(state.player, target.owner) || !isMajor;
      if (canMove) moveArmy(army, id);
    }
    state.selectedArmy = null;
  } else {
    state.selectedProvince = id;
  }
  render();
}

function moveArmy(army, targetId) {
  const target = provinces.find(p => p.id === targetId);
  const enemies = armies.filter(a => a.province === targetId && isAtWar(army.country, a.country));
  
  army.province = targetId;
  
  if (enemies.length > 0 || (target.owner !== army.country && isAtWar(army.country, target.owner))) {
    if (!battles.find(b => b.province === targetId)) {
      battles.push({ province: targetId });
      notify(`Battle in ${target.name}!`);
    }
  } else if (!['DEU','GBR','FRA','RUS','POL','ITA'].includes(target.owner) && target.owner !== army.country) {
    target.owner = army.country;
    notify(`${target.name} occupied!`);
  }
}

// Production system
window.startProduction = function(type) {
  const unit = unitTemplates[type];
  if (state.economy.manpower >= unit.manpower && state.economy.equipment >= unit.equipment) {
    state.economy.manpower -= unit.manpower;
    state.economy.equipment -= unit.equipment;
    state.productionQueue.push({ type, progress: 0, time: unit.time });
    notify(`${unit.name} in production!`);
    render();
  }
};

window.cancelProduction = function(index) {
  const item = state.productionQueue[index];
  const unit = unitTemplates[item.type];
  // Refund half
  state.economy.manpower += Math.floor(unit.manpower * 0.5);
  state.economy.equipment += Math.floor(unit.equipment * 0.5);
  state.productionQueue.splice(index, 1);
  render();
};

let pendingDeploy = null;

function completeProduction(item) {
  pendingDeploy = item.type;
  
  // Get owned provinces for deployment
  const owned = provinces.filter(p => p.owner === state.player);
  document.getElementById('deployGrid').innerHTML = owned.map(p => `
    <div class="deploy-option" onclick="deployUnit('${p.id}')">${countries[p.owner]?.flag || ''} ${p.name}</div>
  `).join('');
  
  document.getElementById('deployModal').classList.remove('hidden');
}

window.deployUnit = function(provId) {
  if (!pendingDeploy) return;
  
  const unit = unitTemplates[pendingDeploy];
  const newArmy = {
    id: nextArmyId++,
    name: `${unit.name.split(' ')[0]} ${nextArmyId}`,
    country: state.player,
    province: provId,
    divisions: pendingDeploy === 'infantry' ? 10 : pendingDeploy === 'armor' ? 5 : 8,
    strength: 100,
    type: pendingDeploy === 'armor' ? 'armor' : 'infantry'
  };
  
  armies.push(newArmy);
  notify(`${unit.name} deployed to ${provinces.find(p => p.id === provId)?.name}!`);
  
  pendingDeploy = null;
  document.getElementById('deployModal').classList.add('hidden');
  render();
};

window.closeDeployModal = function() {
  pendingDeploy = null;
  document.getElementById('deployModal').classList.add('hidden');
};

function notify(msg) {
  const n = document.createElement('div');
  n.className = 'notification';
  n.textContent = msg;
  document.body.appendChild(n);
  setTimeout(() => n.remove(), 3000);
}

// Speed controls
document.getElementById('pauseBtn').onclick = () => setSpeed(0);
document.getElementById('speed1Btn').onclick = () => setSpeed(1);
document.getElementById('speed2Btn').onclick = () => setSpeed(2);
document.getElementById('speed3Btn').onclick = () => setSpeed(3);

function setSpeed(s) {
  state.speed = s;
  document.querySelectorAll('.speed-controls button').forEach((b, i) => b.classList.toggle('active', i === s));
}

let lastTick = 0;
function gameLoop(ts) {
  if (!lastTick) lastTick = ts;
  const rates = [0, 1, 3, 10];
  if (state.speed > 0 && ts - lastTick >= 1000 / rates[state.speed]) {
    lastTick = ts;
    gameTick();
  }
  requestAnimationFrame(gameLoop);
}

function gameTick() {
  state.date.setDate(state.date.getDate() + 1);
  document.getElementById('dateDisplay').textContent = state.date.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
  
  // Economy tick
  state.economy.manpower += state.economy.dailyManpower;
  state.economy.equipment += state.economy.factories.military * 50;
  
  // Production tick
  state.productionQueue.forEach((item, i) => {
    item.progress++;
    if (item.progress >= item.time) {
      completeProduction(item);
      state.productionQueue.splice(i, 1);
    }
  });
  
  // Reinforce armies
  armies.filter(a => a.country === state.player && a.strength < 100).forEach(a => {
    const reinforce = Math.min(5, 100 - a.strength);
    const manpowerCost = reinforce * 100;
    const equipCost = reinforce * 10;
    if (state.economy.manpower >= manpowerCost && state.economy.equipment >= equipCost) {
      a.strength += reinforce;
      state.economy.manpower -= manpowerCost;
      state.economy.equipment -= equipCost;
    }
  });
  
  processBattles();
  processAI();
  checkVictory();
  render();
}

function processBattles() {
  battles = battles.filter(battle => {
    const prov = provinces.find(p => p.id === battle.province);
    if (!prov) return false;
    
    const attackers = armies.filter(a => a.province === battle.province && isAtWar(prov.owner, a.country));
    const defenders = armies.filter(a => a.province === battle.province && a.country === prov.owner);
    
    if (attackers.length === 0) return false;
    
    const atkPow = attackers.reduce((s, a) => s + a.divisions * (a.strength/100) * (a.type === 'armor' ? 1.5 : 1), 0);
    const defPow = defenders.reduce((s, a) => s + a.divisions * (a.strength/100) * 1.2, 0);
    
    attackers.forEach(a => a.strength = Math.max(0, a.strength - Math.random() * 5 * (defPow / Math.max(1, atkPow))));
    defenders.forEach(a => a.strength = Math.max(0, a.strength - Math.random() * 6 * (atkPow / Math.max(1, defPow))));
    
    armies = armies.filter(a => a.strength > 5);
    
    const remDef = armies.filter(a => a.province === battle.province && a.country === prov.owner);
    const remAtk = armies.filter(a => a.province === battle.province && isAtWar(prov.owner, a.country));
    
    if (remDef.length === 0 && remAtk.length > 0) {
      const oldOwner = prov.owner;
      prov.owner = remAtk[0].country;
      notify(`${prov.name} captured from ${countries[oldOwner]?.name}!`);
      
      // Gain industry bonus
      if (prov.owner === state.player) {
        state.economy.factories.military += Math.floor(prov.industry / 20);
      }
      return false;
    }
    
    return remAtk.length > 0;
  });
}

function processAI() {
  armies.filter(a => a.country !== state.player).forEach(army => {
    if (Math.random() > 0.2) return;
    
    const enemies = getEnemies(army.country);
    if (!enemies.length) return;
    
    const adj = adjacency[army.province] || [];
    const targets = adj.filter(p => {
      const pr = provinces.find(x => x.id === p);
      return pr && enemies.includes(pr.owner);
    });
    
    if (targets.length) {
      const t = targets[Math.floor(Math.random() * targets.length)];
      army.province = t;
      if (!battles.find(b => b.province === t)) {
        battles.push({ province: t });
      }
    }
  });
  
  // Germany AI
  if (state.player !== 'DEU') {
    const polandExists = provinces.find(p => p.id === 'POL')?.owner === 'POL';
    if (!isAtWar('DEU', 'FRA') && !polandExists) {
      wars.push({ attacker: 'DEU', defender: 'FRA' });
      wars.push({ attacker: 'DEU', defender: 'GBR' });
      wars.push({ attacker: 'DEU', defender: 'BEL' });
      wars.push({ attacker: 'DEU', defender: 'NLD' });
      notify('Germany attacks the West!');
    }
    if (!isAtWar('DEU', 'RUS') && state.date > new Date(1941, 5, 22)) {
      wars.push({ attacker: 'DEU', defender: 'RUS' });
      notify('Operation Barbarossa!');
    }
  }
}

function checkVictory() {
  const vps = {};
  provinces.forEach(p => vps[p.owner] = (vps[p.owner] || 0) + p.vp);
  
  if (vps[state.player] >= 80) {
    document.getElementById('victoryText').textContent = 'VICTORY!';
    document.getElementById('victoryDesc').textContent = `${countries[state.player].name} dominates with ${vps[state.player]} VP!`;
    document.getElementById('victoryModal').classList.remove('hidden');
    state.speed = 0;
  }
  
  const caps = { DEU: 'DEU', GBR: 'GBR', FRA: 'FRA', RUS: 'RUS' };
  const myCap = provinces.find(p => p.id === caps[state.player]);
  if (myCap && myCap.owner !== state.player) {
    document.getElementById('victoryText').textContent = 'DEFEAT';
    document.getElementById('victoryDesc').textContent = 'Your capital has fallen!';
    document.getElementById('victoryModal').classList.remove('hidden');
    state.speed = 0;
  }
}

// Init
initArmies();
loadGeoJSON();

window.selectCountry = selectCountry;

}); // DOMContentLoaded
</script>
</body>
</html>
