<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Video to GIF Converter with Download</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
            background-color: #f0f2f5;
        }
        h1 {
            margin-bottom: 20px;
        }
        #options {
            margin-top: 20px;
            text-align: left;
            display: inline-block;
            max-width: 100%;
        }
        #options label {
            display: block;
            margin-top: 10px;
        }
        #gif-container, #download-link {
            margin-top: 20px;
        }
        #loader {
            display: none;
            font-size: 18px;
            color: #555;
            margin-top: 20px;
        }
        input[type="number"], input[type="range"] {
            width: 100%;
            max-width: 300px;
        }
        input[type="file"] {
            margin-top: 10px;
        }
        canvas {
            display: none;
        }
        img {
            max-width: 100%;
            height: auto;
        }
        @media (max-width: 600px) {
            #options {
                width: 100%;
            }
        }
    </style>
</head>
<body>

<h1>Convert Video to Looping GIF</h1>

<input type="file" id="video-upload" accept="video/*">

<div id="options">
    <label>
        Start Time (seconds):
        <input type="number" id="start-time" min="0" value="0">
    </label>
    <label>
        GIF Duration (seconds, max 6):
        <input type="number" id="gif-duration" min="1" max="6" value="3">
    </label>
    <label>
        Frame Rate (FPS):
        <input type="number" id="frame-rate" min="1" max="30" value="10">
    </label>
    <label>
        Quality (1 = Best, 30 = Low):
        <input type="number" id="gif-quality" min="1" max="30" value="10">
    </label>
</div>

<button id="convert-button" disabled>Convert to GIF</button>

<p id="loader">Processing video, please wait...</p>
<div id="gif-container"></div>
<a id="download-link" href="#" download="output.gif" style="display:none;">Download GIF</a>

<!-- Include gif.js library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
<!-- Include gif.worker.js as a Blob URL -->
<script>
fetch('https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js')
    .then(response => response.blob())
    .then(blob => {
        var workerBlobURL = URL.createObjectURL(blob);

        // Main script
        var videoFile;
        document.getElementById('video-upload').addEventListener('change', function(event) {
            videoFile = event.target.files[0];
            if (videoFile) {
                document.getElementById('convert-button').disabled = false;
            }
        });

        document.getElementById('convert-button').addEventListener('click', function() {
            if (videoFile) {
                var loader = document.getElementById('loader');
                loader.style.display = 'block';

                var video = document.createElement('video');
                video.src = URL.createObjectURL(videoFile);
                video.crossOrigin = "anonymous";
                video.muted = true;

                video.addEventListener('loadedmetadata', function() {
                    var canvas = document.createElement('canvas');
                    var ctx = canvas.getContext('2d');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;

                    // Get user inputs
                    var startTime = parseFloat(document.getElementById('start-time').value) || 0;
                    var gifDuration = parseFloat(document.getElementById('gif-duration').value) || 3;
                    var frameRate = parseInt(document.getElementById('frame-rate').value) || 10;
                    var gifQuality = parseInt(document.getElementById('gif-quality').value) || 10;

                    // Validate inputs
                    if (startTime < 0 || startTime >= video.duration) {
                        startTime = 0;
                    }
                    gifDuration = Math.min(gifDuration, 6);
                    if (startTime + gifDuration > video.duration) {
                        gifDuration = video.duration - startTime;
                    }

                    var totalFrames = Math.ceil(frameRate * gifDuration);
                    var interval = gifDuration / totalFrames;
                    var currentTime = startTime;

                    var gif = new GIF({
                        workers: 2,
                        quality: gifQuality,
                        workerScript: workerBlobURL,
                        width: canvas.width,
                        height: canvas.height
                    });

                    video.currentTime = currentTime;

                    (function captureFrame() {
                        if (currentTime <= startTime + gifDuration) {
                            video.currentTime = currentTime;
                            video.addEventListener('seeked', function onSeeked() {
                                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                                gif.addFrame(ctx.getImageData(0, 0, canvas.width, canvas.height), {delay: 1000 / frameRate});
                                currentTime += interval;
                                video.removeEventListener('seeked', onSeeked);
                                captureFrame();
                            });
                        } else {
                            gif.on('finished', function(blob) {
                                var gifContainer = document.getElementById('gif-container');
                                gifContainer.innerHTML = '';

                                var animatedImage = document.createElement('img');
                                var url = URL.createObjectURL(blob);
                                animatedImage.src = url;
                                gifContainer.appendChild(animatedImage);

                                // Provide download link
                                var downloadLink = document.getElementById('download-link');
                                downloadLink.href = url;
                                downloadLink.style.display = 'inline';

                                loader.style.display = 'none';
                            });
                            gif.render();
                        }
                    })();
                });
            }
        });
    });
</script>

</body>
</html>
